'''
Created on Jan 11, 2013

__author__ = "Elizabeth 'pidge' Flanagan"
__copyright__ = "Copyright 2012-2013, Intel Corp."
__credits__ = ["Elizabeth Flanagan"]
__license__ = "GPL"
__version__ = "2.0"
__maintainer__ = "Elizabeth Flanagan"
__email__ = "elizabeth.flanagan@intel.com"
'''

from buildbot.steps.shell import ShellCommand
from twisted.python import log
import os, datetime 
from autobuilder.config import *

class PublishArtifacts(ShellCommand):

    haltOnFailure = False 
    flunkOnFailure = True 
    name = "Publishing Artifacts" 
    def __init__(self, factory, argdict=None, **kwargs):
        self.factory = factory
        self.description = "Publishing Artifacts"
        self.slavedir=os.path.join(os.path.join(YOCTO_ABBASE, "yocto-slave"))
        for k, v in argdict.iteritems():
            if type(v) is bool:
                setattr(self, k, str(v))
            else:
                setattr(self, k, v)
        self.timeout = 100000
        kwargs['timeout']=self.timeout
        ShellCommand.__init__(self, **kwargs)

    def start(self):
        DEST=self.getProperty("DEST")
        buildername=self.getProperty("buildername")
        got_revision_poky=self.getProperty("got_revision_poky")
        distroversion=self.getProperty("distroversion")
        self.basedir=os.path.join(os.path.join(
                                    self.slavedir, buildername), 
                                    "build/build/")
        command=""
        DATESTAMP=datetime.datetime.now().strftime("%Y%m%d")
        if str(os.environ.get('PUBLISH_BUILDS')) == "True":
            for artifact in self.artifacts:
                if artifact == "adt-installer":
                    command=command+"mkdir -p " + os.path.join(DEST, ADT_INST_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/sdk/") + \
                                    "*adt* " + os.path.join(DEST, ADT_INST_PUBLISH_DIR) + ";"
                elif artifact == "adt-installer-QA":
                    command=command+"mkdir -p " + os.path.join(DEST, ADTQA_INST_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/sdk/") + \
                                    "*adt* " + os.path.join(DEST, ADTQA_INST_PUBLISH_DIR)+ ";"
                elif artifact == "adtrepo-dev":
                    adt_dev_dest= os.environ.get("ADTREPO_DEV_PATH") + "/" + distroversion + "-" + got_revision_poky + '-' + self.getProperty("branch_poky")
                    command=command+"mkdir -p " + adt_dev_dest + "/adt-ipk;"
                    command=command+"cp -R " + os.path.join(self.basedir, "tmp/deploy/ipk/*") + " " + adt_dev_dest + "/adt-ipk;"
                    command=command+"rsync -av " + os.path.join(self.basedir, "tmp/deploy/ipk/") + " " + DEST + "/ipk;"
                    command=command+"mkdir -p " + adt_dev_dest + "/rootfs;" 
                    command=command+"for x in `ls " + DEST + "/machines/qemu/|grep -v tiny`; do ln -s " + DEST + "/machines/qemu/$x " + adt_dev_dest + "/rootfs/$x; done;"
                    command=command+"mv " + adt_dev_dest + "/rootfs/qemux86-64 " + adt_dev_dest + "/rootfs/qemux86_64;" 
                elif artifact == "eclipse-plugin":
                    command=command+"mkdir -p " + DEST + "/eclipse-plugin;"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                     os.path.join(os.path.join(self.slavedir, buildername), 
                                                 "build/eclipse-poky/scripts/org.*.zip") + \
                                     " " + DEST + "/eclipse-plugin;"
                elif artifact == "build-appliance":
                    command=command+"mkdir -p " + DEST + "/" + BA_PUBLISH_DIR + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/images/*.zip") + \
                                    " " + DEST + "/" + BA_PUBLISH_DIR + ";"
                elif artifact == "buildtools":
                    command=command+"mkdir -p " + DEST + "/buildtools;"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/images/*.tar.*") + \
                                    " " + DEST + "/buildtools;"
                elif artifact == "rpm":
                    command=command+"mkdir -p " + os.path.join(DEST, RPM_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/rpm/* ") + \
                                    os.path.join(DEST, RPM_PUBLISH_DIR) + ";"
                elif artifact == "deb":
                    command=command+"mkdir -p " + os.path.join(DEST, DEB_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/deb/* ") + \
                                    os.path.join(DEST, DEB_PUBLISH_DIR) + ";"
                elif artifact == "ipk":
                    command=command+"mkdir -p " + os.path.join(DEST, IPK_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/ipk/* ") + \
                                    os.path.join(DEST, IPK_PUBLISH_DIR) + ";"
                elif artifact == "toolchain":
                    command=command+"mkdir -p " + os.path.join(DEST, X86TC_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/sdk/poky-eglibc-i686* ") + \
                                    os.path.join(DEST, X86TC_PUBLISH_DIR) + ";"
                    command=command+"mkdir -p " + os.path.join(DEST, X8664TC_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/sdk/poky-eglibc-x86_64* ") + \
                                    os.path.join(DEST, X8664TC_PUBLISH_DIR) + ";"
                elif artifact == "oe-toolchain":
                    command=command+"mkdir -p " + os.path.join(DEST, X86TC_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/sdk/oecore-i686* ") + \
                                    os.path.join(DEST, X86TC_PUBLISH_DIR) + ";"
                    command=command+"mkdir -p " + os.path.join(DEST, X8664TC_PUBLISH_DIR) + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/sdk/oecore-x86_64* ") + \
                                    os.path.join(DEST, X8664TC_PUBLISH_DIR) + ";"
                elif "qemu" in artifact:
                    command=command+"mkdir -p " + DEST + "/" + QEMU_PUBLISH_DIR + "/" + artifact + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/images/") + \
                                    "*" + artifact + "* " + DEST + "/" + QEMU_PUBLISH_DIR + "/" + artifact + ";"
                elif "mpc8315e" in artifact:
                    command=command+"mkdir -p " + DEST + "/" + MACHINE_PUBLISH_DIR + "/" + artifact + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/images/") + \
                                    "*mpc8315* " + DEST + "/" + MACHINE_PUBLISH_DIR + "/" + artifact + ";"
                elif artifact == "tiny":
                    command=command+"mkdir -p " + DEST + "/" + QEMU_PUBLISH_DIR + "/qemu-tiny;"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                    os.path.join(self.basedir, "tmp/deploy/images/") + \
                                    "* " + DEST + "/" + QEMU_PUBLISH_DIR + "/qemu-tiny;"
                elif artifact == "conf":
                    command=command+"mkdir -p " + DEST + "/"+ MACHINE_PUBLISH_DIR + "/" + buildername + "/conf;"
                    command=command+"cp -R --no-dereference " + \
                                     os.path.join(self.basedir, "conf/") + \
                                     "* " + DEST + "/" + MACHINE_PUBLISH_DIR + "/" + buildername + "/conf;"
                else:
                    command=command+"mkdir -p " + DEST + "/"+ MACHINE_PUBLISH_DIR +"/" + artifact + ";"
                    command=command+"cp -R --no-dereference --preserve=links " + \
                                     os.path.join(self.basedir, "tmp/deploy/images/") + \
                                     "*"+artifact+"* " + DEST + "/" + MACHINE_PUBLISH_DIR +"/" + artifact + ";"


            self.command = command
        else:
            self.command = "echo 'Skipping Step.'"
        ShellCommand.start(self)

    def describe(self, done=False):
        description = ShellCommand.describe(self,done)
        return description

